<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHS Referral Letter Generator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        
        const FileText = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const Copy = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );

        const Check = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
        );

        function ReferralGenerator() {
            const [tortusOutput, setTortusOutput] = useState('');
            const [additionalContext, setAdditionalContext] = useState('');
            const [uploadedImages, setUploadedImages] = useState([]);
            const [selectedDestination, setSelectedDestination] = useState('');
            const [customDestination, setCustomDestination] = useState('');
            const [generatedLetter, setGeneratedLetter] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [copied, setCopied] = useState(false);

            const destinations = [
                'Cardiology',
                'Orthopaedics',
                'Gastroenterology',
                'Respiratory Medicine',
                'Endocrinology',
                'Neurology',
                'Dermatology',
                'Urology',
                'General Surgery',
                'ENT',
                'Ophthalmology',
                'Psychiatry',
                'Geriatrics',
                'Rheumatology',
                'Social Services',
                'Housing Department',
                'Occupational Health',
                'TWIMC (General)',
                'Custom'
            ];

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                const imagePromises = files.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            resolve({
                                name: file.name,
                                data: event.target.result.split(',')[1],
                                type: file.type
                            });
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                });

                const newImages = await Promise.all(imagePromises);
                setUploadedImages([...uploadedImages, ...newImages]);
            };

            const removeImage = (index) => {
                setUploadedImages(uploadedImages.filter((_, i) => i !== index));
            };

            const generateLetter = async () => {
                if (!tortusOutput.trim() || !selectedDestination) {
                    alert('Please provide Tortus output and select a destination');
                    return;
                }

                const destination = selectedDestination === 'Custom' ? customDestination : selectedDestination;
                if (!destination) {
                    alert('Please specify a destination');
                    return;
                }

                setIsGenerating(true);
                setGeneratedLetter('');

                try {
                    const messageContent = [];
                    
                    messageContent.push({
                        type: 'text',
                        text: `You are generating a professional NHS referral letter. Create a comprehensive, well-structured referral letter based on the following information:

DESTINATION: ${destination}

CONSULTATION OUTPUT (from Tortus AI scribe):
${tortusOutput}

${additionalContext ? `ADDITIONAL CONTEXT:
${additionalContext}` : ''}

${uploadedImages.length > 0 ? `Note: ${uploadedImages.length} supporting image(s) are attached (lab results, past records, etc.)` : ''}

Please create a referral letter that:
1. Uses appropriate formal NHS letter structure
2. Has a clear, concise subject line
3. Provides relevant background and history
4. States the reason for referral clearly
5. Includes pertinent examination findings
6. References relevant investigations
7. States what you're asking the receiving service to do
8. Is tailored to the specific specialty/destination
9. Maintains appropriate clinical detail without unnecessary verbosity
10. Follows the structure: Background, Current Presentation, Examination, Investigations, Request

The letter should be ready to copy and paste into EMIS or other systems.`
                    });

                    uploadedImages.forEach(img => {
                        messageContent.push({
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: img.type,
                                data: img.data
                            }
                        });
                    });

                    // Call our Netlify function instead of Anthropic API directly
                    const response = await fetch('/.netlify/functions/generate-letter', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: [{
                                role: 'user',
                                content: messageContent
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to generate letter');
                    }
                    
                    const letter = data.content
                        .filter(block => block.type === 'text')
                        .map(block => block.text)
                        .join('\n');

                    setGeneratedLetter(letter);
                } catch (error) {
                    console.error('Error generating letter:', error);
                    alert(`Failed to generate letter: ${error.message}`);
                } finally {
                    setIsGenerating(false);
                }
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(generatedLetter);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const clearAll = () => {
                setTortusOutput('');
                setAdditionalContext('');
                setUploadedImages([]);
                setSelectedDestination('');
                setCustomDestination('');
                setGeneratedLetter('');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center gap-3 mb-6">
                                <FileText className="w-8 h-8 text-blue-600" />
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">NHS Referral Letter Generator</h1>
                                    <p className="text-gray-600">Transform Tortus output into rich, specialty-specific referral letters</p>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Tortus Consultation Output *
                                        </label>
                                        <textarea
                                            value={tortusOutput}
                                            onChange={(e) => setTortusOutput(e.target.value)}
                                            className="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Paste the consultation output from Tortus AI scribe here..."
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Additional Context
                                        </label>
                                        <textarea
                                            value={additionalContext}
                                            onChange={(e) => setAdditionalContext(e.target.value)}
                                            className="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Add any additional context: past medical history, current medications, social circumstances, etc."
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Supporting Documents (Images)
                                        </label>
                                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                            <input
                                                type="file"
                                                accept="image/*"
                                                multiple
                                                onChange={handleImageUpload}
                                                className="hidden"
                                                id="image-upload"
                                            />
                                            <label htmlFor="image-upload" className="cursor-pointer">
                                                <Upload className="w-8 h-8 mx-auto text-gray-400 mb-2" />
                                                <p className="text-sm text-gray-600">
                                                    Upload lab results, past records, images
                                                </p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    Click to browse or drag and drop
                                                </p>
                                            </label>
                                        </div>
                                        {uploadedImages.length > 0 && (
                                            <div className="mt-2 space-y-1">
                                                {uploadedImages.map((img, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-gray-50 p-2 rounded">
                                                        <span className="text-sm text-gray-700">{img.name}</span>
                                                        <button
                                                            onClick={() => removeImage(idx)}
                                                            className="text-red-600 hover:text-red-800 text-sm"
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Referral Destination *
                                        </label>
                                        <select
                                            value={selectedDestination}
                                            onChange={(e) => setSelectedDestination(e.target.value)}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                            <option value="">Select destination...</option>
                                            {destinations.map(dest => (
                                                <option key={dest} value={dest}>{dest}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {selectedDestination === 'Custom' && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Custom Destination
                                            </label>
                                            <input
                                                type="text"
                                                value={customDestination}
                                                onChange={(e) => setCustomDestination(e.target.value)}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                placeholder="e.g., Community Mental Health Team"
                                            />
                                        </div>
                                    )}

                                    <div className="flex gap-3">
                                        <button
                                            onClick={generateLetter}
                                            disabled={isGenerating || !tortusOutput.trim() || !selectedDestination}
                                            className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                        >
                                            {isGenerating ? (
                                                <>
                                                    <Loader2 className="w-5 h-5 animate-spin" />
                                                    Generating...
                                                </>
                                            ) : (
                                                'Generate Letter'
                                            )}
                                        </button>
                                        <button
                                            onClick={clearAll}
                                            className="px-6 py-3 border border-gray-300 rounded-lg font-medium hover:bg-gray-50"
                                        >
                                            Clear All
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <label className="block text-sm font-medium text-gray-700">
                                            Generated Referral Letter
                                        </label>
                                        {generatedLetter && (
                                            <button
                                                onClick={copyToClipboard}
                                                className="flex items-center gap-2 px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded"
                                            >
                                                {copied ? (
                                                    <>
                                                        <Check className="w-4 h-4" />
                                                        Copied!
                                                    </>
                                                ) : (
                                                    <>
                                                        <Copy className="w-4 h-4" />
                                                        Copy
                                                    </>
                                                )}
                                            </button>
                                        )}
                                    </div>
                                    <div className="h-[600px] p-4 border border-gray-300 rounded-lg bg-white overflow-y-auto">
                                        {generatedLetter ? (
                                            <pre className="whitespace-pre-wrap font-sans text-sm text-gray-800">
                                                {generatedLetter}
                                            </pre>
                                        ) : (
                                            <div className="h-full flex items-center justify-center text-gray-400">
                                                <div className="text-center">
                                                    <FileText className="w-16 h-16 mx-auto mb-3 opacity-50" />
                                                    <p>Your generated referral letter will appear here</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 className="font-medium text-blue-900 mb-2">Tips for Better Referrals</h3>
                            <ul className="text-sm text-blue-800 space-y-1">
                                <li>• Include relevant past medical history and medications in additional context</li>
                                <li>• Upload images of recent lab results, ECGs, or imaging reports</li>
                                <li>• Be specific about what you're asking the receiving service to do</li>
                                <li>• The app will tailor the letter style to the selected specialty</li>
                                <li>• Review and edit the generated letter before sending</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ReferralGenerator />, document.getElementById('root'));
    </script>
</body>
</html>
